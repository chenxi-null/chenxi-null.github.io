

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="chenxi">
  <meta name="keywords" content="">
  
    <meta name="description" content="å¼‚æ­¥æ“ä½œï¼ŒåŒ…æ‹¬è¿›ç¨‹å†…çš„å¼‚æ­¥æ“ä½œï¼Œä¹ŸåŒ…æ‹¬è·¨ç³»ç»Ÿçš„è°ƒç”¨ï¼Œå¦‚ MQ çš„å‘å¸ƒ-è®¢é˜…åœºæ™¯ï¼Œå¼‚æ­¥ä»»åŠ¡ä¸­é—´ä»¶åœºæ™¯ç­‰ï¼Œå¼‚æ­¥æ“ä½œé€šå¸¸å¯ä»¥æå‡ç³»ç»Ÿçš„ååé‡ã€é™ä½æ¨¡å—è€¦åˆï¼Œä½†åœ¨æˆ‘ä»¬å¹³æ—¶çš„å†™å•å…ƒ&#x2F;é›†æˆæµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚ä½•å¯¹è¿™äº›å¼‚æ­¥æ“ä½œè¿›è¡Œæµ‹è¯•å´æˆäº†ä¸€ä¸ªéš¾é¢˜ã€‚ æœ¬æ–‡åˆ—ä¸¾äº†å‡ ç§æµ‹è¯•å¼‚æ­¥æ“ä½œçš„è§£å†³æ–¹æ¡ˆï¼Œå¸Œæœ›ä¸ºå¤§å®¶æä¾›ä¸€äº›æ€è·¯ï¼Œå¸®åŠ©å¤§å®¶å†™å‡ºæ›´ç®€æ´ä¼˜é›…çš„ä»£ç ğŸ˜„ ä»£ç ä¸­çš„æµ‹è¯•ç”¨ä¾‹æ˜¯ç”¨ Spock å†™çš„ï¼Œä¸ç†Ÿæ‚‰ Spock">
<meta property="og:type" content="article">
<meta property="og:title" content="TDD å®æˆ˜ â€” å¦‚ä½•æµ‹è¯•å¼‚æ­¥ä»»åŠ¡">
<meta property="og:url" content="http://yoursite.com/2020/07/21/tdd-in-action-async-assert/index.html">
<meta property="og:site_name" content="Chenxi&#39;s Blog">
<meta property="og:description" content="å¼‚æ­¥æ“ä½œï¼ŒåŒ…æ‹¬è¿›ç¨‹å†…çš„å¼‚æ­¥æ“ä½œï¼Œä¹ŸåŒ…æ‹¬è·¨ç³»ç»Ÿçš„è°ƒç”¨ï¼Œå¦‚ MQ çš„å‘å¸ƒ-è®¢é˜…åœºæ™¯ï¼Œå¼‚æ­¥ä»»åŠ¡ä¸­é—´ä»¶åœºæ™¯ç­‰ï¼Œå¼‚æ­¥æ“ä½œé€šå¸¸å¯ä»¥æå‡ç³»ç»Ÿçš„ååé‡ã€é™ä½æ¨¡å—è€¦åˆï¼Œä½†åœ¨æˆ‘ä»¬å¹³æ—¶çš„å†™å•å…ƒ&#x2F;é›†æˆæµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚ä½•å¯¹è¿™äº›å¼‚æ­¥æ“ä½œè¿›è¡Œæµ‹è¯•å´æˆäº†ä¸€ä¸ªéš¾é¢˜ã€‚ æœ¬æ–‡åˆ—ä¸¾äº†å‡ ç§æµ‹è¯•å¼‚æ­¥æ“ä½œçš„è§£å†³æ–¹æ¡ˆï¼Œå¸Œæœ›ä¸ºå¤§å®¶æä¾›ä¸€äº›æ€è·¯ï¼Œå¸®åŠ©å¤§å®¶å†™å‡ºæ›´ç®€æ´ä¼˜é›…çš„ä»£ç ğŸ˜„ ä»£ç ä¸­çš„æµ‹è¯•ç”¨ä¾‹æ˜¯ç”¨ Spock å†™çš„ï¼Œä¸ç†Ÿæ‚‰ Spock">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yoursite.com/images/2020-07-29-11-43-33.png">
<meta property="article:published_time" content="2020-07-21T07:00:00.000Z">
<meta property="article:modified_time" content="2025-03-03T12:54:44.147Z">
<meta property="article:author" content="Chenxi">
<meta property="article:tag" content="TDD">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://yoursite.com/images/2020-07-29-11-43-33.png">
  
  
  
  <title>TDD å®æˆ˜ â€” å¦‚ä½•æµ‹è¯•å¼‚æ­¥ä»»åŠ¡ - Chenxi&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"yoursite.com","root":"/","version":"1.9.8","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null},"tajs":null,"woyaola":null,"cnzz":null},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 25vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Chenxi&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>é¦–é¡µ</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>å½’æ¡£</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>åˆ†ç±»</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>æ ‡ç­¾</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>å…³äº</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle">TDD å®æˆ˜ â€” å¦‚ä½•æµ‹è¯•å¼‚æ­¥ä»»åŠ¡</span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2020-07-21 15:00" pubdate>
          2020å¹´7æœˆ21æ—¥ ä¸‹åˆ
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          1.2k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          10 åˆ†é’Ÿ
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">TDD å®æˆ˜ â€” å¦‚ä½•æµ‹è¯•å¼‚æ­¥ä»»åŠ¡</h1>
            
            
              <div class="markdown-body">
                
                <p>å¼‚æ­¥æ“ä½œï¼ŒåŒ…æ‹¬è¿›ç¨‹å†…çš„å¼‚æ­¥æ“ä½œï¼Œä¹ŸåŒ…æ‹¬è·¨ç³»ç»Ÿçš„è°ƒç”¨ï¼Œå¦‚ MQ çš„å‘å¸ƒ-è®¢é˜…åœºæ™¯ï¼Œå¼‚æ­¥ä»»åŠ¡ä¸­é—´ä»¶åœºæ™¯ç­‰ï¼Œå¼‚æ­¥æ“ä½œé€šå¸¸å¯ä»¥æå‡ç³»ç»Ÿçš„ååé‡ã€é™ä½æ¨¡å—è€¦åˆï¼Œä½†åœ¨æˆ‘ä»¬å¹³æ—¶çš„å†™å•å…ƒ&#x2F;é›†æˆæµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚ä½•å¯¹è¿™äº›å¼‚æ­¥æ“ä½œè¿›è¡Œæµ‹è¯•å´æˆäº†ä¸€ä¸ªéš¾é¢˜ã€‚</p>
<p>æœ¬æ–‡åˆ—ä¸¾äº†å‡ ç§æµ‹è¯•å¼‚æ­¥æ“ä½œçš„è§£å†³æ–¹æ¡ˆï¼Œå¸Œæœ›ä¸ºå¤§å®¶æä¾›ä¸€äº›æ€è·¯ï¼Œå¸®åŠ©å¤§å®¶å†™å‡ºæ›´ç®€æ´ä¼˜é›…çš„ä»£ç ğŸ˜„</p>
<p>ä»£ç ä¸­çš„æµ‹è¯•ç”¨ä¾‹æ˜¯ç”¨ Spock å†™çš„ï¼Œä¸ç†Ÿæ‚‰ Spock è¿™ä¸€æµ‹è¯•æ¡†æ¶çš„åŒå­¦å¯ä»¥çœ‹ä¸‹æˆ‘ä¹‹å‰å†™çš„è¿™ç¯‡æ–‡ç«  <a href="/2019/01/28/Spock-Tutorial-for-Javaer/">Spock-Tutorial-for-Javaer</a></p>
<p>ä¸‹é¢ä»¥ä¸€ä¸ªé‚®ä»¶å‘é€çš„æ¡ˆä¾‹ä½œä¸ºæˆ‘ä»¬çš„ä¾‹å­ï¼š<br><code>AsyncMailSender</code> æ˜¯é‚®ä»¶å‘é€è€…ï¼Œé€šè¿‡è°ƒç”¨ <code>sendMail</code> æ–¹æ³•å¼‚æ­¥åœ°å‘é€é‚®ä»¶ï¼Œç›¸å½“äº MQ åœºæ™¯ä¸­çš„ Producer è§’è‰²ï¼›<br><code>MailBox</code> æ˜¯é‚®ä»¶çš„æ¥å—è€…ï¼Œç›¸å½“äº MQ ä¸­çš„ Consumer è§’è‰²ã€‚</p>
<p>æœ€ç®€å•æš´åŠ›çš„æ–¹å¼å°±æ˜¯ä½¿ç”¨ sleep äº†:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">def <span class="hljs-string">&quot;async assert with sleep&quot;</span>() &#123;<br>    <span class="hljs-keyword">when</span>: <span class="hljs-string">&quot;invoke async operation&quot;</span><br>    asyncMailSender.sendMail(msg)<br><br>    then:<br>    sleep(<span class="hljs-number">2000</span>)<br>    and:<br>    mailBox.containsMail(msg)<br>&#125;<br></code></pre></td></tr></table></figure>
<p>è¿™æ ·çš„ç¼ºç‚¹å°±æ˜¯ sleep çš„æ—¶é—´é•¿åº¦éš¾ä»¥æ§åˆ¶ï¼Œè®¾ç½®é•¿äº†ä¼šå¢å¤§æµ‹è¯•çš„è€—æ—¶ï¼Œè®¾ç½®çŸ­äº†å¯èƒ½å‡ºç° consumer è¿˜æ²¡æ”¶åˆ°æ¶ˆæ¯çš„æƒ…å†µï¼Œå¯¼è‡´æµ‹è¯•å¤±è´¥</p>
<p>é’ˆå¯¹ sleep çš„ç¼ºé™·ï¼Œæ›´å¥½çš„è§£å†³æ–¹æ¡ˆä¹Ÿæ¯”è¾ƒå®¹æ˜“æƒ³åˆ°ï¼Œé‚£å°±æ˜¯ä½¿ç”¨<strong>è½®è¯¢</strong>çš„æ–¹å¼ï¼Œä¸æ–­æ£€æŸ¥ consumer æ˜¯å¦æ¥æ”¶åˆ°æŒ‡å®šçš„æ¶ˆæ¯ï¼Œæ”¶åˆ°çš„è¯å°±è¿”å› assert æˆåŠŸï¼Œå¦‚æœè¶…è¿‡è®¾ç½®çš„æœ€å¤§ç­‰å¾…æ—¶é—´è¿˜æ²¡æœ‰æ”¶åˆ°æ¶ˆæ¯å°±è¿”å›å¤±è´¥ã€‚</p>
<h2 id="è½®è¯¢"><a href="#è½®è¯¢" class="headerlink" title="è½®è¯¢"></a>è½®è¯¢</h2><p>å¯¹äºè¿™ç§éœ€æ±‚ï¼Œç¤¾åŒºæ—©å°±æœ‰æ¯”è¾ƒæˆç†Ÿçš„å·¥å…·ï¼Œä¸éœ€è¦æˆ‘ä»¬å†é‡å¤é€ è½®å­äº†</p>
<h3 id="Awaitility"><a href="#Awaitility" class="headerlink" title="Awaitility"></a>Awaitility</h3><p>åŒæ—¶æ”¯æŒ Java å’Œ Groovyï¼Œæä¾›äº†ä¸°å¯Œçš„ DSL é£æ ¼çš„ API</p>
<p><a href="https://github.com/awaitility/awaitility">Awaitility</a> åœ¨ github ä¸Šçš„ä»‹ç»:</p>
<blockquote>
<p>Awaitility is a small Java DSL for synchronizing asynchronous operations</p>
<p>Testing asynchronous systems is hard. Not only does it require handling threads, timeouts and concurrency issues, but the intent of the test code can be obscured by all these details. Awaitility is a DSL that allows you to express expectations of an asynchronous system in a concise and easy to read manner.</p>
</blockquote>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-comment">// https://github.com/awaitility/awaitility/wiki/Groovy</span><br><span class="hljs-keyword">def</span> <span class="hljs-string">&quot;async assert with Awaitility&quot;</span>() &#123;<br>    <span class="hljs-symbol">when:</span> <span class="hljs-string">&quot;invoke async operation&quot;</span><br>    asyncMailSender.sendMail(msg)<br><br>    <span class="hljs-symbol">then:</span><br>    await().atLeast(Duration.ofMillis(<span class="hljs-number">10</span>)).atMost(Duration.ofSeconds(<span class="hljs-number">3</span>))<br>            .until(&#123; mailBox.numOfReceivedMail() &#125;, equalTo(<span class="hljs-number">1</span>))<br>    <span class="hljs-symbol">and:</span><br>    mailBox.containsMail(msg)<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="PollingCondition-of-Spock"><a href="#PollingCondition-of-Spock" class="headerlink" title="PollingCondition of Spock"></a>PollingCondition of Spock</h3><p>PollingCondition æ˜¯ Spock è‡ªå¸¦çš„ï¼Œä¸ªäººè®¤ä¸ºå®ƒçš„è¯­æ³•æ¯” Awaitility æ›´ç®€æ´</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-keyword">def</span> <span class="hljs-string">&quot;async assert with PollingCondition&quot;</span>() &#123;<br>    PollingConditions pollingConditions = <span class="hljs-keyword">new</span> PollingConditions()<br><br>    <span class="hljs-symbol">when:</span><br>    asyncMailSender.sendMail(msg)<br><br>    <span class="hljs-symbol">then:</span><br>    pollingConditions.within(<span class="hljs-number">2</span>, &#123; mailBox.containsMail(msg) &#125;)<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="ä¸»åŠ¨é€šçŸ¥"><a href="#ä¸»åŠ¨é€šçŸ¥" class="headerlink" title="ä¸»åŠ¨é€šçŸ¥"></a>ä¸»åŠ¨é€šçŸ¥</h2><p>é™¤äº†è½®è¯¢ consumerã€ä¸æ–­æ£€æŸ¥ consumer çŠ¶æ€è¿™ç§æ–¹æ¡ˆï¼Œè¿˜å¯ä»¥åŸºäº wait-notify çš„æ¨¡å‹ï¼Œè®© consumer åœ¨æ»¡è¶³æ¡ä»¶åä¸»åŠ¨é€šçŸ¥ â€œæ–­è¨€è€…â€</p>
<h3 id="åœ¨-Receiver-å¤„æ·»åŠ -Hook-Callback"><a href="#åœ¨-Receiver-å¤„æ·»åŠ -Hook-Callback" class="headerlink" title="åœ¨ Receiver å¤„æ·»åŠ  Hook&#x2F;Callback"></a>åœ¨ Receiver å¤„æ·»åŠ  Hook&#x2F;Callback</h3><p>å¯¹ä»£ç æœ‰ä¸€å®šä¾µå…¥æ€§ï¼Œå¦‚ä½•è¿™é‡Œ Hook åªæ˜¯ä¸ºæµ‹è¯•æœåŠ¡çš„è¯</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-keyword">def</span> <span class="hljs-string">&quot;async assert by modifying feat code, for example, adding hook&quot;</span>() &#123;<br>    <span class="hljs-symbol">given:</span><br>    <span class="hljs-keyword">def</span> f = <span class="hljs-keyword">new</span> CompletableFuture()<br>    Mailbox mailbox = <span class="hljs-keyword">new</span> Mailbox()<br>    mailbox.setReceivedHook &#123; msg -&gt; f.complete(msg) &#125;<br>    AsyncMailSender asyncMailSender = <span class="hljs-keyword">new</span> AsyncMailSender(mailbox)<br><br>    <span class="hljs-symbol">when:</span><br>    asyncMailSender.sendMail(msg)<br><br>    <span class="hljs-symbol">then:</span><br>    msg == f.get()<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="Mock-Receiver"><a href="#Mock-Receiver" class="headerlink" title="Mock Receiver"></a>Mock Receiver</h3><p>è¿˜æœ‰ä¸€ç§æ€è·¯ï¼Œå¦‚æœä¸å…³å¿ƒ receiver çš„å†…éƒ¨é€»è¾‘ï¼Œåªå…³å¿ƒ receiver çš„ receive æ–¹æ³• (ä¾‹å­é‡Œæ˜¯ <code>MailBox.receiveMail</code>) æ˜¯å¦è¢«è°ƒç”¨è¿‡çš„è¯ï¼Œå¯ä»¥è€ƒè™‘ç›´æ¥å¯¹ receiver è¿›è¡Œ mockï¼Œåœ¨ mock é€»è¾‘é‡Œæ·»åŠ  notify çš„ä»£ç ï¼Œç„¶ååœ¨ assert å¤„ç­‰å¾…ï¼Œè¿™é‡Œçš„ wait-and-notify æµç¨‹å’Œä¸Šé¢çš„ä¾‹å­æ˜¯ä¸€è‡´çš„ã€‚</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-keyword">def</span> <span class="hljs-string">&quot;async assert by mocking receiver&quot;</span>() &#123;<br>    <span class="hljs-symbol">given:</span><br>    <span class="hljs-keyword">def</span> f = <span class="hljs-keyword">new</span> CompletableFuture()<br>    Mailbox mailbox = Stub &#123;<br>        receiveMail(_) &gt;&gt; &#123; String _msg -&gt; f.complete(msg) &#125;<br>    &#125;<br>    AsyncMailSender asyncMailSender = <span class="hljs-keyword">new</span> AsyncMailSender(mailbox)<br><br>    <span class="hljs-symbol">when:</span><br>    asyncMailSender.sendMail(msg)<br><br>    <span class="hljs-symbol">then:</span><br>    msg == f.get()<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="AsyncCondition-of-Spock"><a href="#AsyncCondition-of-Spock" class="headerlink" title="AsyncCondition of Spock"></a>AsyncCondition of Spock</h3><p>ä¸Šé¢çš„ä¸¤ä¸ªä¾‹å­æ˜¯é€šè¿‡ JDK çš„ <code>CompletableFuture</code> å®ç° wait-and-notify çš„ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–çš„ JDK APIï¼Œæ¯”å¦‚ <code>CountDownLatch</code> ç­‰ï¼Œè¿™é‡Œæ¨èä¸€ä¸ª Spock å†…ç½®çš„å·¥å…· â€”â€” AsyncCondition:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-keyword">def</span> <span class="hljs-string">&quot;async assert with `AsyncCondition`&quot;</span>() &#123;<br>    <span class="hljs-symbol">given:</span><br>    <span class="hljs-keyword">def</span> asyncConditions = <span class="hljs-keyword">new</span> AsyncConditions()<br>    Mailbox mailbox = Stub &#123;<br>        receiveMail(_) &gt;&gt; &#123; String _msg -&gt; asyncConditions.evaluate &#123; <span class="hljs-keyword">assert</span> _msg == msg &#125; &#125;<br>    &#125;<br>    AsyncMailSender asyncMailSender = <span class="hljs-keyword">new</span> AsyncMailSender(mailbox)<br><br>    <span class="hljs-symbol">when:</span><br>    asyncMailSender.sendMail(msg)<br><br>    <span class="hljs-symbol">then:</span><br>    asyncConditions.await(<span class="hljs-number">2</span>)<br>&#125;<br></code></pre></td></tr></table></figure>
<p>AsyncCondition çš„ä½¿ç”¨æ–¹æ³•å’Œ <code>CompletableFuture</code> ä»¥åŠ <code>CountDownLatch</code> æ˜¯å·®ä¸å¤šçš„ï¼Œä½†å¥½å¤„æ˜¯å¯ä»¥åˆ©ç”¨ Spock åœ¨ assert å¤±è´¥æ—¶ä¼šæ‰“å°è¯¦ç»†çš„å¤±è´¥ä¿¡æ¯è¿™ä¸€ç‰¹æ€§ï¼Œåœ¨ assert å¤æ‚å¯¹è±¡å‡ºç°å¤±è´¥æ—¶ï¼Œæ–¹ä¾¿æ’æŸ¥ï¼Œe.g:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-keyword">def</span> <span class="hljs-string">&quot;AsyncConditions can report detailed failed result of assertion&quot;</span>() &#123;<br>    <span class="hljs-keyword">def</span> asyncConditions = <span class="hljs-keyword">new</span> AsyncConditions()<br>    <span class="hljs-symbol">when:</span><br>    <span class="hljs-keyword">def</span> msg = <span class="hljs-keyword">new</span> Message(<span class="hljs-attr">id:</span> <span class="hljs-number">100</span>, <span class="hljs-attr">content:</span> <span class="hljs-string">&#x27;content1&#x27;</span>, <span class="hljs-attr">tag:</span> <span class="hljs-string">&#x27;tag1&#x27;</span>);<br>    Thread.start &#123;<br>        asyncConditions.evaluate &#123;<br>            verifyAll(msg) &#123;<br>                id == <span class="hljs-number">101</span><br>                content == <span class="hljs-string">&#x27;content2&#x27;</span><br>                tag == <span class="hljs-string">&#x27;tag1&#x27;</span><br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-symbol">then:</span><br>    asyncConditions.await(<span class="hljs-number">1</span>)<br>&#125;<br></code></pre></td></tr></table></figure>
<p><img src="/images/2020-07-29-11-43-33.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="å­—èŠ‚ç ç”Ÿæˆå·¥å…·"><a href="#å­—èŠ‚ç ç”Ÿæˆå·¥å…·" class="headerlink" title="å­—èŠ‚ç ç”Ÿæˆå·¥å…·"></a>å­—èŠ‚ç ç”Ÿæˆå·¥å…·</h3><p>æˆ‘åœ¨ç½‘ä¸Šè¿˜çœ‹åˆ°è¿‡ä½¿ç”¨å­—èŠ‚ç ç”Ÿæˆå·¥å…·æ¥æµ‹è¯•å¼‚æ­¥æ“ä½œçš„â€œå¥‡æŠ€æ·«å·§â€ï¼Œæœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥çœ‹ä¸‹è¿™ç¯‡æ–‡ç« ï¼š<br><a href="https://dzone.com/articles/testing-asynchronous-operations-in-spring-with-spo">Testing Asynchronous Operations in Spring With Spock and Byteman - DZone Performance</a></p>
<hr>
<h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><p>ä¸Šé¢ä»‹ç»çš„å‡ ç§æ–¹æ³•éƒ½æ˜¯æ¯”è¾ƒé€šç”¨çš„ï¼Œä¸ç®¡æ˜¯é’ˆå¯¹è¿›ç¨‹å†…è¿˜æ˜¯è·¨è¿›ç¨‹çš„å¼‚æ­¥åœºæ™¯éƒ½æ˜¯é€‚ç”¨çš„ï¼Œä½†å¦‚æœæˆ‘ä»¬è¦æµ‹è¯•çš„ä»…ä»…æ˜¯è¿›ç¨‹å†…éƒ¨çš„å¼‚æ­¥é€šä¿¡åœºæ™¯ï¼Œå…¶å®å¯ä»¥å°è¯•å¦‚ä¸‹æ–¹å¼:<br>å¦‚æœ Producer æ˜¯é€šè¿‡çº¿ç¨‹æ± çš„æ–¹å¼å¼‚æ­¥è°ƒç”¨ Consumer çš„ receive æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç­‰å¾… Producer çš„çº¿ç¨‹æ± æ‰§è¡Œç»“æŸåï¼Œå†å» assert Consumer</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-keyword">def</span> <span class="hljs-string">&quot;async assert with JDK Thread APIs&quot;</span>() &#123;<br>    <span class="hljs-symbol">when:</span><br>    asyncMailSender.sendMail(msg)<br><br>    <span class="hljs-symbol">and:</span> <span class="hljs-string">&quot;wait that all tasks have completed execution in thread pool&quot;</span><br>    ExecutorService executorService = asyncMailSender.getExecutorService()<br>    executorService.shutdown()<br>    executorService.awaitTermination(<span class="hljs-number">2</span>, TimeUnit.SECONDS)<br>    log.debug(executorService.toString())<br><br>    <span class="hljs-symbol">then:</span><br>    mailBox.containsMail(msg)<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<p>ä»¥ä¸Šè¿™äº›æµ‹è¯•ç”¨ä¾‹çš„å®Œæ•´ä»£ç å¯ä»¥é€šè¿‡æˆ‘çš„ <a href="https://github.com/chenxi-null/tdd/blob/master/async-assertion/src/test/groovy/com/chenxi/tdd/async/AsyncMailSenderTest.groovy">github ä»“åº“</a> è·å–</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/TDD/" class="category-chain-item">TDD</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/TDD/" class="print-no-link">#TDD</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>TDD å®æˆ˜ â€” å¦‚ä½•æµ‹è¯•å¼‚æ­¥ä»»åŠ¡</div>
      <div>http://yoursite.com/2020/07/21/tdd-in-action-async-assert/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>chenxi</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2020å¹´7æœˆ21æ—¥</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>è®¸å¯åè®®</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/04/14/Spock%E5%85%A5%E9%97%A8/" title="å†™ç»™ Java å¼€å‘è€…çœ‹çš„ Spock å¿«é€Ÿå…¥é—¨">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">å†™ç»™ Java å¼€å‘è€…çœ‹çš„ Spock å¿«é€Ÿå…¥é—¨</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/06/05/seata-src-code-graceful-shutdown/" title="Seata åˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶ æºç è§£æ â€” ä¼˜é›…åœæœº">
                        <span class="hidden-mobile">Seata åˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶ æºç è§£æ â€” ä¼˜é›…åœæœº</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>ç›®å½•</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>





  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
